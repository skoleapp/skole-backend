name: "CI"

on: pull_request

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout code (pre merge)"
      uses: actions/checkout@v2
      with:
        # Checkout the current commit instead of the commit that would get
        # made when the PR would be merged, since we want to validate that
        # the branch doesn't contain any merge commits and is rebased correctly.
        # We also fetch all the objects here so that we can do the comparisons.
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: "Check commits of the PR branch"
      run: ./.github/check_commits.sh

    - name: "Checkout code (post merge)"
      uses: actions/checkout@v2

    - name: "Set up Docker Buildx"
      uses: docker/setup-buildx-action@v1

    - name: "Set up Docker layer caching"
      uses: actions/cache@v2
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: "Login to Dockerhub"
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: "Build and cache the image"
      uses: docker/build-push-action@v2
      with:
        context: .
        target: ci
        build-args: install_dev_dependencies=1
        tags: backend-ci
        load: true
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new

    - name: "Move cache"
      # https://github.com/docker/build-push-action/issues/252
      # https://github.com/moby/buildkit/issues/1896
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: "Run linters, type-check, and tests"
      run: >
        docker-compose --file .github/docker-compose-ci.yml up --abort-on-container-exit
        && docker cp backend-ci:/home/user/app/coverage.xml .

    - name: "Upload coverage to Codecov"
      uses: codecov/codecov-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        fail_ci_if_error: true
